\section{Hecke Operators}
Thoughout this section, we fix the following data:\begin{itemize}
    \item a group $\Omega$;
    \item a submonoid $\Delta\subset\Omega$;
    \item a nonempty collection $\mathscr{X}$ of subgroups of $\Omega$, in which all members are commensurable\footnote{Write $\Gamma\approx \Gamma'$ if $\Gamma$ is commensurable to $\Gamma'$.} to each other, 
    and \[\Gamma\subset\Delta\subset\tilde\Gamma := \left\{ g\in\Omega \mid g\Gamma g^{-1}\approx\Gamma \right\},\ \forall \Gamma\in\mathscr{X};\]
    \item a commutative ring $\mathbb K$'
    \item a left $\K$-module $M$ with a right $\Delta$-action $(m, \delta)\mapsto m\delta$, i.e, a monoid homomorphism \[\Delta\to\enom_{\K}(M)\quad \delta\mapsto m\mapsto m\delta.\]
\end{itemize}

\subsection{Commensurability}
Recall that two subgroups $\Gamma, \Gamma' < \Omega$ are commensurable if both $[\Gamma : \Gamma\cap\Gamma']$ and $[\Gamma' : \Gamma\cap\Gamma']$ are finite,
and this is an equivalence relation.

\begin{lemma}
    $\tilde{\Gamma}$ is a group and depends only on the commensurable class of $\Gamma$.\qed
\end{lemma}

\begin{proposition}
    Let $\alpha\in\tilde{\Gamma}$ and $\Gamma\approx\Gamma'$.
    Then there is a bijection
    \begin{align*}
        \Gamma'\cap (\alpha^{-1}\Gamma\alpha) \backslash \Gamma'
        &\longleftrightarrow \Gamma\backslash\Gamma\alpha\Gamma'\\
        \Gamma''\footnotemark x&\longleftrightarrow \Gamma\alpha x
    \end{align*}\footnotetext{Of course, $\Gamma'' = \Gamma'\cap (\alpha^{-1}\Gamma\alpha) $.}
    and $\Gamma\backslash\Gamma\alpha\Gamma'$ is finite.
\end{proposition}
\begin{proof}
    The map \[\Gamma'\to \Gamma\backslash\Gamma\alpha\Gamma'\quad x\mapsto \Gamma\alpha x\]
    is clearly surjective.
    Now $\forall x, y\in\Gamma'$,\begin{align*}
        \Gamma\alpha x = \Gamma\alpha y&\iff \exists g\in\Gamma, g\alpha x= \alpha y\\
        &\iff\exists g'\in\Gamma'', g'x = y;
    \end{align*}
    so injective.

    By definitions and the last lemma, $\Gamma'\cap (\alpha^{-1}\Gamma\alpha)\approx \Gamma'$, giving finiteness.
\end{proof}


\subsection{Double Coset Algebra}

\subsubsection{Double Cosets and Convolution}
Recall that the $\K$-module $\mathcal{F}(\Omega, \K)$ of all functions $\Omega\to\K$ admits a $\K$-linear left $\Omega$-action\[(\gamma f)(z) := f(\gamma^{-1}z)\]
and a right $\Omega$-action \[(f\gamma)(z) := f(z\gamma).\]
\begin{defthm}
    Let $\Gamma, \Gamma'\in\mathscr{X}$. Define $\hecke(\bico{\Delta}{\Gamma}{\Gamma'})$
    to be the $\K$-module\footnote{A $\K$-submodule of $\mathcal{F}(\Omega, \K)$} consists of functions $f : \Omega\to\K$ such that:
    \begin{itemize}
        \item $\supp f\subset\Delta$ and $\bico{\supp f\!}{\Gamma}{\Gamma'}$ is a finite set,
        \item $f$ is left-$\Gamma$-invariant and right-$\Gamma'$-invariant.
    \end{itemize}
    Then $\hecke(\bico{\Delta}{\Gamma}{\Gamma'})$ is a \textit{free} $\K$-module,
    with a basis given by the double cosets in $\bico{\Delta}{\Gamma}{\Gamma'}$, i.e., \[[\Gamma\gamma\Gamma'] := \boldsymbol{1}_{\Gamma\gamma\Gamma'},\ \gamma\in\Delta.\]
    We thus identify $\hecke(\bico{\Delta}{\Gamma}{\Gamma'})$ with the free module $\Z[\bico{\Delta}{\Gamma}{\Gamma'}]$ generated by $\bico{\Delta}{\Gamma}{\Gamma'}$, and we identify the function $[\Gamma\gamma\Gamma'] := \boldsymbol{1}_{\Gamma\gamma\Gamma'}$ with the double coset $\Gamma\gamma\Gamma'$.
\end{defthm}

\begin{defthm}[Convolution]
    Let $\Gamma, \Gamma', \Gamma''\in\mathscr{X}$.
    We define an convolution operator \[* : \hecke(\bico{\Delta}{\Gamma}{\Gamma'})\times\hecke(\bico{\Delta}{\Gamma'}{\Gamma''})\to \hecke(\bico{\Delta}{\Gamma}{\Gamma''})\]
    via \[(\alpha *\beta)(x) := \sum_{h\in\Gamma'\backslash\Omega} \alpha(xh^{-1})\beta(h) = \sum_{\Omega/\Gamma'}\alpha(h)\beta(h^{-1}x).\]
    The above equation is well-defined and holds.
    Moreover,\begin{itemize}
        \item this convolution operator $*$ is \textit{distributive} and \textit{associative},
        \item $1_{\Gamma}\in\hecke(\bico{\Delta}{\Gamma}{\Gamma})$ is both a left and right \textit{identity} for $*$.
    \end{itemize}
    In particular, the operator $*$ makes \[\hecke_\Delta(\Gamma) := \hecke(\bico{\Delta}{\Gamma}{\Gamma})\] a $\K$-algebra.
\end{defthm}

We then give a formula of $*$.
For $\alpha, \beta, \gamma\in\Delta$, write
\[[\Gamma\alpha\Gamma']*[\Gamma'\beta\Gamma''] = \sum_{\gamma\in \bico{\Gamma}{\Delta}{\Gamma''}} m(\alpha, \beta; \gamma) [\Gamma\gamma\Gamma''].\]
Apply RHS to $\gamma$, one checks $\left([\Gamma\alpha\Gamma']*[\Gamma'\beta\Gamma'']\right)(\gamma) = m(\alpha, \beta; \gamma)$.
To determine these quantities,
write \[\Gamma\alpha\Gamma' = \bigsqcup_{a\in A} \Gamma a,\ \Gamma'\beta\Gamma'' = \bigsqcup_{b\in B}\Gamma' b.\]
Then\begin{align*}
    m(\alpha, \beta; \gamma) &= \left([\Gamma\alpha\Gamma']*[\Gamma'\beta\Gamma'']\right)(\gamma)\\
    &= \sum_{h\in\Gamma'\backslash\Omega}[\Gamma\alpha\Gamma'](\gamma h^{-1})\cdot [\Gamma'\beta\Gamma''](h)\\
    &= \sum_{h\in\Gamma'\backslash (\Gamma'\beta\Gamma'')} [\Gamma\alpha\Gamma'](\gamma h^{-1}) = \sum_{b\in B} [\Gamma\alpha\Gamma'](\gamma b^{-1}).
    % \\
    % &= \# \left\{b\in B \mid \gamma b^{-1}\in \Gamma\alpha\Gamma' = \bigsqcup_{a\in A}\Gamma a\right\}\\
    % &= \#\left\{ b\in B\mid \exists a\in A, \gamma b^{-1} \in \Gamma a \right\}\\
    % \implies m(\alpha, \beta; \gamma)&= \#\left\{ (a, b)\in A\times B\mid \Gamma \gamma = \Gamma ab \right\}.
\end{align*}
Note that \[[\Gamma\alpha\Gamma'](x) =
\left\{ \begin{matrix}
    1, &\exists a\in A, x\in \Gamma a\\
    0, &\text{otherwise} 
\end{matrix} \right\} =  \#\{a\in A \mid \Gamma x = \Gamma a\},\]
so \[m(\alpha, \beta; \gamma)= \#\left\{ (a, b)\in A\times B\mid \Gamma \gamma = \Gamma ab \right\}.\]
Considering right cosets rather than left cosets gives a similar formula.

The following is a useful result in computation.
\begin{proposition}\label{alpha * beta = alpha beta if normalises}
    If $\alpha, \gamma\in\Delta$, and $\gamma$ normalises $\Gamma$, then \[[\Gamma\alpha\Gamma]*[\Gamma\gamma\Gamma] = [\Gamma\alpha\gamma\Gamma],\]
    \[[\Gamma\gamma\Gamma]*[\Gamma\alpha\Gamma] = [\Gamma\gamma\alpha\Gamma].\]
\end{proposition}
\begin{proof}
    Write $\Gamma\alpha\Gamma = \bigsqcup_{a\in A}\Gamma a$.
    As $\Gamma\gamma\Gamma = \Gamma\gamma$
    and \[\Gamma\alpha\gamma\Gamma = \Gamma\alpha\Gamma\gamma = \bigsqcup_{a\in A}\Gamma a\gamma,\]
    the structure constants\[
        m(\alpha, \gamma; \delta) = \#\left\{ a\in A\mid \Gamma\delta = \Gamma a\gamma \right\} = \begin{cases}
            1, &\delta\in\Gamma\alpha\gamma\Gamma,\\
            0, &\delta\notin\Gamma\alpha\gamma\Gamma.
        \end{cases}
    \qedhere\]
\end{proof}

\subsubsection{Commutativity}
An \textbf{anti involution} of a monoid $\Delta$
is a map $\tau : \Delta\to\Delta$ s.t. \[\tau(xy) = \tau(y)\tau(x),\quad \tau(1) = 1,\quad \tau^2 := \tau\circ\tau = \Id.\]
\begin{theorem}\label{hecke alg comm if anti involution}
    Let $\Gamma\in\mathscr{X}$.
    If there \textit{exists} an anti involution $\tau : \Delta\to \Delta$ that stabilises every double coset of $\Gamma$, then $\hecke(\bico{\Delta}{\Gamma}{\Gamma})$ is a commutative $\K$-algebra.
\end{theorem}
% \begin{lemma}
%     If $\tau$ is an anti involution of $\Delta$, 
%     then \[\tau^* : \hecke(\bico{\Delta}{\tau\Gamma}{\tau\Gamma})\to \hecke(\bico{\Delta}{\Gamma}{\Gamma})\quad f\mapsto f\circ\tau\]
%     satisfies \[\tau^*(\alpha)*\tau^*(\beta) = \tau^*(\beta*\alpha).\]
% \end{lemma}
% \begin{proof}

% \end{proof}

% \begin{proof}[Proof of the theorem]
%     As $\tau(\Gamma\gamma\Gamma) = \Gamma\gamma\Gamma$ for all $\gamma\in\Delta$,
%     we get particularly that $\tau(\Gamma) = \Gamma$. 

% \end{proof}

\subsection{The Action of Double Coset Algebras}

We consider the action of $\hecke(\bico{\Delta}{\Gamma}{\Gamma})$ on \[M^\Gamma = \{m\in M\mid m\gamma = m, \forall \gamma\in\Gamma\}.\]

\begin{defthm}
    For $f\in\hecke(\bico{\Delta}{\Gamma}{\Gamma'})$, define \begin{align*}
        \cdot f : M^\Gamma &\longrightarrow M^{\Gamma'}\\
            m &\longmapsto mf :=
            \sum_{\delta\in\Gamma\backslash\Delta}
                f(\delta) m\delta.
    \end{align*}
    This action is well-defined.
    Moreover, it is comptatible with convolution.\begin{itemize}
        \item If $f\in\hecke(\bico{\Delta}{\Gamma}{\Gamma'})$, $f'\in\hecke(\bico{\Delta}{\Gamma'}{\Gamma''})$, then $m(f*f') = (mf)f'$.
        \item In case $\Gamma' = \Gamma$, $m \boldsymbol{1}_\Gamma = m$.
    \end{itemize}
    In particular, $M^\Gamma$ admits a right $\hecke(\bico{\Delta}{\Gamma}{\Gamma})$-module,
    with action of a basis given by \[\Gamma\gamma\Gamma = \bigsqcup_{i=1}^n \Gamma \gamma_i
    \implies m[\Gamma\gamma\Gamma] = \sum_{i=1}^n\gamma_i.\]
\end{defthm}
\begin{corollary}
    If $\gamma$ normalises $\Gamma$, then $m[\Gamma
    \gamma\Gamma] = m\gamma$.\qed
\end{corollary}

\section{\texorpdfstring{{Hecke Operators for $\Gamma_0(N)$ and $\Gamma_1(N)$}}{Hecke Operators for Gamma0(N) and Gamma1(N)}}

We specialise our discussion in the last section to the case of modular forms. Let \begin{itemize}
    \item $\Omega := \GL(2, \Q)^+$,
    \item $\K := \Z$,
    \item $\mathscr{X} = $ congruence subgroups,
\end{itemize}

\begin{lemma}
    Any two congruence subgroups are commensurable.
\end{lemma}
\begin{proof}
    Note that $\Gamma(N)\cap \Gamma(N') = \Gamma(\mathrm{lcm}(N, N'))$.
\end{proof}
\begin{lemma}
    If $\Gamma$ is a discrete subgroup of $\SL(2,\Z)$, then in $\GL(2, \Q)^+$, the group $\tilde{\Gamma} = \GL(2, \Q)^+$.
\end{lemma}
\begin{proof}
    
\end{proof}


Fix a weight $k$ and consider all the modular forms \[M := \bigcup_{\Gamma\in\mathscr{X}} M_k(\Gamma) = \sum_{\Gamma} M_k(\Gamma)\]
and its $\C$-subspace \[S := \bigcup_{\Gamma\in\mathscr{X}} S_k(\Gamma) = \sum_{\Gamma} S_k(\Gamma).\]
\begin{itemize}
    \item Note that we can write $\bigcup = \sum$, because \[M_k(\Gamma) + M_k(\Gamma')\subset M_k(\Gamma\cap\Gamma').\]
\end{itemize}
Define $M\boldsymbol{\circlearrowleft} \GL(2, \R)^+$ by \[f|_k\gamma(z) := (\det \gamma)^{k-1}j(\gamma, z)^{-k} f(\gamma z).\]
\begin{lemma}
    For all $\Gamma\in\mathscr{X}$ and $\gamma\in\GL(2, \R)^+$, \[f\in M_k(\Gamma)\implies f|_k\gamma\in M_k(\Gamma\cap\gamma^{-1}\Gamma\gamma).\]
    It remains true for $S_k$.
\end{lemma}
\begin{proof}
    Just don't forget to check the cusps!
\end{proof}
It is now straightforward to check that we defined an action on $M$ which stabilises $S$.
\begin{lemma}
    $M^\Gamma = M_k(\Gamma)$, $S^\Gamma = S_k(\Gamma)$.
\end{lemma}
% \begin{proof}
%     Same remark as the last lemma.
% \end{proof}
Now we go to the case of $\Gamma_0(N)$ and $\Gamma_1(N)$.

\subsection{The Algebras}
We consider these monoids:
\begin{align*}
    \Delta(N) := {}& \left\{ A = \left.\begin{pmatrix}
        a&b\\c&d
    \end{pmatrix}\right|\det A > 0,\ (a, N) = 1,\ N\mid c \right\}\\
        ={} & \left\{ A\in\GL(2, \Q)^+\cap \mathrm{M}_2(\Z)\left| A\bmod N\in \begin{pmatrix}
            (\Z/N\Z)^\times & * \\ & *
        \end{pmatrix}\right. \right\},
        \\
    \Delta^\circ(N) :={}& \left\{ A\in\Delta(N) \mid (\det A, N) = 1 \right\},\\
    \Delta_1(N) :={} &\left\{ A = \left.\begin{pmatrix}
        a&b\\c&d
    \end{pmatrix}\in\Delta^1(N)\right|a\equiv 1\pmod N \right\}\\
    ={}& \left\{ A\in\GL(2, \Q)^+\cap \mathrm{M}_2(\Z)\left| A\bmod N\in \begin{pmatrix}
        1 & * \\ & *
    \end{pmatrix}\right. \right\}.
\end{align*}
Define \[\hecke_i(N) := \hecke_{\Delta(N)}(\Gamma_i(N)),\quad \hecke_i^\circ(N) := \hecke_{\Delta^\circ(N)}(\Gamma_i(N)),\qquad i=0, 1\]
and $\hecke_1(N) := \hecke_{\Delta_1(N)}(\Gamma_1(N))$.

\begin{proposition}
    All the algebras mentioned above are commutative.
\end{proposition}
\begin{proof}
    Check that \[A = \begin{pmatrix}
        a & b \\ cN & d
    \end{pmatrix}\mapsto
    \begin{pmatrix}
        a & c \\ bN & d
    \end{pmatrix} = \left( \begin{pmatrix}
        1 & \\ & N
    \end{pmatrix}^{-1} A \begin{pmatrix}
        1 & \\ & N
    \end{pmatrix} \right)^{\mathrm{t}} \]
    verifies the conditions of \cref{hecke alg comm if anti involution}.
\end{proof}

We are particularly interested in $\hecke_0(N)$ and $\hecke_1(N)$.

\subsection{Product Formula for $\hecke_0(N)$}

\begin{theorem}[coset representative of $\hecke_0(N)$]\label{coset representative of R0N}
    $\bico{\Delta(N)}{\Gamma_0(N)}{\Gamma_0(N)}$
    admits coset representative given by \[\begin{pmatrix}
        u &\\ & v
    \end{pmatrix},\quad u\mid v,\ (u, N) = 1.\]
    The double coset of $\begin{pmatrix}
        a &b\\c&d
    \end{pmatrix}$ correspond to\[\begin{pmatrix}
        u &\\ & v
    \end{pmatrix},\quad\text{where } \begin{cases}
        uv = ad - bc\\
        u = (a, b, c, d).
    \end{cases}\]
\end{theorem}

\begin{proposition}
    \[\Gamma_0(N)\begin{pmatrix}
        u & \\ & v
    \end{pmatrix}\Gamma_0(N) = \bigsqcup_{g\in M_{u, uv}}\Gamma_0(N)g,\]
    where \[M_{u, n} = \left\{
        \begin{pmatrix}
            a & b \\ & d
        \end{pmatrix}\in \mathrm{M}_2(\Z)\left|
        \begin{matrix}
            &u = (a, b, d)\\ 
            &n = ad\\
            &(a, N) = 1\\
            &b \text{ permutes a representative of } \Z/d\Z
        \end{matrix}
        \right.
    \right\}.\]
    In particular,\[\Gamma_0(N)\begin{pmatrix}
        1 & \\ & n
    \end{pmatrix}\Gamma_0(N) = \bigsqcup_{g\in M_{1, n}}\Gamma_0(N)g\]
    and \[M_{1, n} = \left\{
        \begin{pmatrix}
            a & b \\ & d
        \end{pmatrix}\in \mathrm{M}_2(\Z)\left|
        \begin{matrix}
            &(a, b, d) = 1\\ 
            &ad = n\\
            &(a, N) = 1\\
            &b \text{ permutes a representative of } \Z/d\Z
        \end{matrix}
        \right.
    \right\}. \]


\end{proposition}

\begin{proposition}[multiplication formula]\label{multiplication formula for diag (1 n)}
    Write $[A] := [\Gamma_0(N) A\Gamma_0(N)]$. Let $n, m\in\Z$, $p$ be a prime.
    \begin{itemize}
        \item If $(n, m) = 1$, then \[\left[ \begin{pmatrix}
            1&\\ & n
        \end{pmatrix} \right]\left[ \begin{pmatrix}
            1&\\ & m
        \end{pmatrix} \right] = \left[ \begin{pmatrix}
            1&\\ & nm
        \end{pmatrix} \right].\]
        \item If $p\mid N$, then
        \[\left[ \begin{pmatrix}
            1&\\ & p
        \end{pmatrix} \right]\left[ \begin{pmatrix}
            1&\\ & p^r
        \end{pmatrix} \right] = \left[ \begin{pmatrix}
            1&\\ & p^{r+1}
        \end{pmatrix} \right].\]

        \item If $p\nmid N$, then
        \[\left[ \begin{pmatrix}
            1&\\ & p
        \end{pmatrix} \right]\left[ \begin{pmatrix}
            1&\\ & p^r
        \end{pmatrix} \right] = \begin{cases}
            \left[ \begin{pmatrix}
            1&\\ & p^{2}
        \end{pmatrix} \right] + (p+1)\left[ \begin{pmatrix}
            p&\\ & p
        \end{pmatrix} \right], & r = 1,\\
        & \\
        \left[ \begin{pmatrix}
            1&\\ & p^{r + 1}
        \end{pmatrix} \right]+ p\left[ \begin{pmatrix}
            p&\\ & p
        \end{pmatrix}\begin{pmatrix}
            1 &\\ & p^{r-1}
        \end{pmatrix} \right], & r\ge 2.
        \end{cases} \]
    \end{itemize}
\end{proposition}
\begin{proof}
    Note that $\diag(u, u)$ lies in the centre of $\GL(2, \Q)^+$, so \[\left[ \begin{pmatrix}
        u &\\ & v
    \end{pmatrix} \right] = \left[ \begin{pmatrix}
        u & \\ & u
    \end{pmatrix}\begin{pmatrix}
        1 & \\ & v/u
    \end{pmatrix} \right],\]
    and thus we need only to prove the formula for $\diag(1, n)$.

    To be continued....
\end{proof}


\subsection{From $\Gamma_0$ to $\Gamma_1$}

Recall that \[\Gamma_0(N)\to(\Z/N\Z)^\times\quad \begin{pmatrix}
    *&*\\*&d
\end{pmatrix}\mapsto \bar{d}\] induces a group isomorphism \[\Gamma_0(N)/\Gamma_1(N)\simeq (\Z/N\Z)^\times.\]
\begin{definition}
    [diamond operator]
    For $d\in(\Z/N\Z)^\times$, define \[\left<d\right> := [\Gamma_1(N)\gamma_d\Gamma_1(N)],\]
    where $\gamma_d\in\Gamma_0(N)$ is any lift of $d$.
\end{definition}
\begin{itemize}
    \item The operator $\left<d\right>$ is independent to the choice of $\gamma_d$, because the $\gamma_d$'s differ by an element in $\Gamma_1(N)$.
    \item $\left< d\right>\left<d'\right> = \left<dd'\right>$.
\end{itemize}


\subsection{Another Basis}
\begin{definition}
    [operator $T(n)$]
    Let $n\in\Z_{\ge 1}$ and consider \[\Delta^n(N) := \left\{ A\in\Delta(N)\mid \det A = n \right\}.\]
    Write $\bico{\Delta^n(N )}{\Gamma_0(N)}{\Gamma_0(N)} = \bigsqcup_{i} \Gamma_0(N)g_i\Gamma_0(N)$, we define \[T(n) := \sum_{i} [\Gamma_0(N)g_i\Gamma_0(N)].\]
    By \cref{coset representative of R0N}, we may take \[\begin{pmatrix}
        u & \\ & n/u
    \end{pmatrix}\text{  with }\begin{cases}
        (u, N) = 1,\\ u^2\mid n,
    \end{cases}\]yielding\begin{align*}
        T(n) &= \sum_{u} \left[ \begin{pmatrix}
            u & \\ & n/u
        \end{pmatrix} \right]\\ 
        &=\sum_{u} \left[ \begin{pmatrix}
            u & \\ & u
        \end{pmatrix}\begin{pmatrix}
            1 & \\ & n/u^2
        \end{pmatrix} \right].
    \end{align*}
    as the representative $g_i$'s, which in turn shows that $\bico{\Delta^n(N )}{\Gamma_0(N)}{\Gamma_0(N)}$ is a finite set and $T(n)$ is well-defined.
    In particular, for $p$ prime, \[T(p) = \left[ \begin{pmatrix}
        1&\\ &p
    \end{pmatrix} \right].\]
\end{definition}

\subsection{Hecke Algebra}
Define \begin{align}
    \mathbb{T}_i(N) &:= \im \left( \hecke_i(N)\to \enom_{\C} (M_k(N))\right)\\
    T_n &:= \text{image of } T(n)\in\hecke_i(N)
 \end{align}
for $i = 0, 1$.





